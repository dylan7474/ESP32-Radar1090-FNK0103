#!/bin/bash
set -euo pipefail

# Garuda/Arch doesn't use DEBIAN_FRONTEND, removing it.

echo "==> Base packages"
# -Syu: Sync, Update, and Install
# --needed: Don't reinstall if already up to date
# --noconfirm: Don't ask for confirmation (automatic yes)
sudo pacman -Syu --noconfirm
sudo pacman -S --needed --noconfirm \
  curl ca-certificates git python python-pyserial tar xz unzip arduino-cli

# --- Proxy handling ---
HTTP_PROXY="${HTTP_PROXY:-${http_proxy:-}}"
HTTPS_PROXY="${HTTPS_PROXY:-${https_proxy:-$HTTP_PROXY}}"
NO_PROXY="${NO_PROXY:-${no_proxy:-localhost,127.0.0.1,::1}}"
export HTTP_PROXY HTTPS_PROXY NO_PROXY
export http_proxy="${HTTP_PROXY:-}"
export https_proxy="${HTTPS_PROXY:-}"
export no_proxy="${NO_PROXY:-}"

# --- Prefer IPv4 ---
# Arch doesn't always have /etc/gai.conf by default, so we ensure it exists first
if [ ! -f /etc/gai.conf ]; then
    echo "Creating /etc/gai.conf..."
    sudo touch /etc/gai.conf
fi

if ! grep -q '^precedence ::ffff:0:0/96 100' /etc/gai.conf 2>/dev/null; then
  echo 'precedence ::ffff:0:0/96 100' | sudo tee -a /etc/gai.conf > /dev/null
fi

# --- Helper: retry with backoff ---
retry () {
  local attempts="$1"; shift
  local sleep_s="$1"; shift
  local n=1
  until "$@"; do
    if [[ $n -ge $attempts ]]; then
      echo "Command failed after $n attempts: $*" >&2
      return 1
    fi
    echo "Retry $n/$attempts failed. Sleeping ${sleep_s}s…"
    n=$((n+1))
    sleep "$sleep_s"
  done
}

echo "==> Checking arduino-cli version"
# We installed this via pacman, so we skip the manual curl/install commands
arduino-cli version

echo "==> Resetting arduino-cli config"
# CRITICAL FIX: Force remove the config file to clear invalid keys
rm -f "$HOME/.arduino15/arduino-cli.yaml"
# We only remove root config if we are running as root, otherwise permissions error might occur
if [ "$EUID" -eq 0 ]; then
    rm -f "/root/.arduino15/arduino-cli.yaml"
fi

arduino-cli config init --overwrite

# Enable ZIP installation (unsafe install)
arduino-cli config set library.enable_unsafe_install true
arduino-cli config set network.connection_timeout 600s

# Boards index + proxy
arduino-cli config set board_manager.additional_urls \
  https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json

if [[ -n "${HTTPS_PROXY}" || -n "${HTTP_PROXY}" ]]; then
  arduino-cli config set network.proxy "${HTTPS_PROXY:-$HTTP_PROXY}"
fi

echo "==> Updating indexes (via proxy, with retries)"
retry 5 5 arduino-cli core update-index
retry 5 5 arduino-cli lib update-index

echo "==> Installing ESP32 core"
retry 5 5 arduino-cli core install esp32:esp32

echo "==> Installing libraries"
retry 5 5 arduino-cli lib install "ArduinoJson"
retry 5 5 arduino-cli lib install "TFT_eSPI"

# --- Example: Installing from ZIP ---
# Uncomment if you have the file ready:
# arduino-cli lib install --zip-path lvgl_v8.4.0.zip

# Verify installation
# Checking typical User installation path
if [ ! -d "$HOME/Arduino/libraries/TFT_eSPI" ] && [ ! -d "$HOME/.arduino15/packages" ]; then
  echo "⚠️ Warning: TFT_eSPI directory not found. Check logs."
else
  echo "✅ TFT_eSPI installed successfully."
fi

# AUTOMATION: Configure TFT_eSPI for Freenove FNK0103
# Uses arduino-cli to find the exact path regardless of OS defaults
LIB_PATH=$(arduino-cli config dump | grep "user:" | cut -d' ' -f2)/libraries/TFT_eSPI

if [ -f "$LIB_PATH/User_Setup_Select.h" ]; then
  echo "==> Patching TFT_eSPI configuration for FNK0103 at $LIB_PATH"
  sed -i 's|^#include <User_Setup.h>|//#include <User_Setup.h>|g' "$LIB_PATH/User_Setup_Select.h"
  echo "" >> "$LIB_PATH/User_Setup_Select.h"
  echo "// Auto-configured for FNK0103" >> "$LIB_PATH/User_Setup_Select.h"
  echo "#define FNK0103S_4P0_320x480_ST7796" >> "$LIB_PATH/User_Setup_Select.h"
fi

echo "✅ Setup complete. Compile with:"
echo "   arduino-cli compile --fqbn esp32:esp32:esp32 sketches/freenove"
